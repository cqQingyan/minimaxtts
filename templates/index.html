<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniMax 语音合成助手</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            padding-top: 40px;
            padding-bottom: 40px;
        }
        .main-card {
            border: none;
            border-radius: 12px;
            overflow: hidden;
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #f0f0f0;
            padding: 1.5rem;
        }
        .form-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }
        .btn-check:checked + .btn-outline-primary {
            background-color: #0d6efd;
            color: #fff;
        }
        #text {
            min-height: 150px;
            resize: vertical;
        }
        .status-alert {
            display: none;
        }
    </style>
</head>
<body>

<div class="container" style="max-width: 720px;">
    <div class="card main-card shadow-sm">
        <div class="card-header text-center">
            <h2 class="mb-0 fw-bold text-primary"><i class="bi bi-mic-fill me-2"></i>MiniMax 语音合成</h2>
        </div>
        <div class="card-body p-4">
            
            <div id="connection-status" class="alert text-center py-2 mb-4" style="display: none;" role="alert"></div>

            <!-- Mode Switch -->
            <div class="mb-4">
                <label class="form-label d-block">生成模式</label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="mode" id="mode-sync" value="sync" checked onchange="toggleMode()">
                    <label class="btn btn-outline-primary" for="mode-sync">
                        <i class="bi bi-lightning-fill me-1"></i> 同步模式 (短文本)
                    </label>

                    <input type="radio" class="btn-check" name="mode" id="mode-async" value="async" onchange="toggleMode()">
                    <label class="btn btn-outline-primary" for="mode-async">
                        <i class="bi bi-cloud-upload-fill me-1"></i> 异步模式 (长文本/文件)
                    </label>
                </div>
            </div>

            <!-- Voice Selection -->
            <div class="mb-4">
                <label for="voice_id" class="form-label">选择音色</label>
                <select class="form-select" id="voice_id">
                    {% for voice in voices %}
                    <option value="{{ voice.id }}">{{ voice.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- File Upload (Async Only) -->
            <div id="upload-group" class="mb-4 bg-light p-3 rounded border" style="display: none;">
                <label for="file-upload" class="form-label text-primary">
                    <i class="bi bi-file-earmark-text me-1"></i> 上传文件 (TXT/EPUB)
                </label>
                <input class="form-control" type="file" id="file-upload" accept=".txt,.epub">
                <div class="form-text">支持 TXT 和 EPUB 格式。上传文件后，下方的文本框可留空。</div>
            </div>

            <!-- Text Input -->
            <div class="mb-4">
                <label for="text" class="form-label">文本内容</label>
                <textarea class="form-control" id="text" placeholder="在此输入需要转换的文本..."></textarea>
            </div>

            <!-- Generate Button -->
            <div class="d-grid">
                <button id="generate-btn" class="btn btn-primary btn-lg" onclick="startGeneration()">
                    <i class="bi bi-play-circle-fill me-2"></i>开始生成
                </button>
            </div>

            <!-- Status & Result Area -->
            <div id="status-area" class="mt-4">
                <div id="status-alert" class="alert alert-secondary status-alert text-center" role="alert">
                    <span id="status-text">准备就绪</span>
                </div>
                <div id="result-container" class="text-center mt-3"></div>
            </div>

        </div>
    </div>
    <div class="text-center mt-3 text-muted small">
        &copy; MiniMax TTS Tool
    </div>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let pollInterval;

    function toggleMode() {
        const mode = document.querySelector('input[name="mode"]:checked').value;
        const uploadGroup = document.getElementById('upload-group');
        const textInput = document.getElementById('text');
        
        if (mode === 'async') {
            uploadGroup.style.display = 'block';
            textInput.placeholder = "如果不使用文件上传，请在此输入长文本...";
        } else {
            uploadGroup.style.display = 'none';
            textInput.placeholder = "在此输入需要转换的短文本...";
            // Reset file input
            document.getElementById('file-upload').value = '';
        }
    }

    // Check connection automatically on load just to ensure backend is ready (optional)
    window.onload = checkConnection;

    async function checkConnection() {
        const statusDiv = document.getElementById('connection-status');

        // Only show if error
        statusDiv.style.display = 'none';

        try {
            const response = await fetch('/api/check_connection', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
                // No body needed, uses backend config
            });
            
            const data = await response.json();
            
            if (!response.ok || data.status !== 'success') {
                statusDiv.style.display = 'block';
                statusDiv.classList.add('alert-danger');
                statusDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>服务连接问题: ${data.message || '请联系管理员配置API'}`;
            }
        } catch (error) {
            console.error("Connectivity check failed", error);
        }
    }

    async function startGeneration() {
        // No user-provided API key/Group ID anymore
        const voiceId = document.getElementById('voice_id').value.trim();
        const text = document.getElementById('text').value.trim();
        const mode = document.querySelector('input[name="mode"]:checked').value;
        const fileInput = document.getElementById('file-upload');
        
        const btn = document.getElementById('generate-btn');
        const statusAlert = document.getElementById('status-alert');
        const statusText = document.getElementById('status-text');
        const resultContainer = document.getElementById('result-container');

        // Validation
        if (!voiceId) {
            alert("请选择音色");
            return;
        }
        
        if (mode === 'sync' && !text) {
             alert("同步模式必须输入文本");
             return;
        }
        
        if (mode === 'async' && !text && fileInput.files.length === 0) {
             alert("异步模式必须输入文本 或 上传文件");
             return;
        }

        // Reset UI
        btn.disabled = true;
        statusAlert.style.display = 'block';
        statusAlert.className = 'alert alert-info status-alert text-center';
        resultContainer.innerHTML = '';
        
        try {
            if (mode === 'sync') {
                // --- SYNC MODE ---
                statusText.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>正在生成中 (同步模式)，请稍候...';
                
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mode: 'sync',
                        // Credentials handled by backend
                        voice_id: voiceId,
                        text: text
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || errorData.message || '生成失败');
                }
                
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                
                statusAlert.className = 'alert alert-success status-alert text-center';
                statusText.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>生成成功！';
                createDownloadLink(url);
                
            } else {
                // --- ASYNC MODE ---
                let textFileId = null;
                
                // 1. Upload File (if exists)
                if (fileInput.files.length > 0) {
                    statusText.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>正在上传文件...';
                    
                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);
                    // Credentials handled by backend
                    
                    const uploadResp = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const uploadData = await uploadResp.json();
                    if (!uploadResp.ok) throw new Error(uploadData.error || '文件上传失败');
                    if (uploadData.base_resp && uploadData.base_resp.status_code !== 0) throw new Error(uploadData.base_resp.status_msg || '文件上传失败(API)');
                    
                    textFileId = uploadData.file.file_id;
                    statusText.innerHTML = `<i class="bi bi-cloud-check me-2"></i>文件上传成功 (ID: ${textFileId})，正在提交任务...`;
                } else {
                    statusText.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>正在提交任务...';
                }
                
                // 2. Submit Task
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mode: 'async',
                        // Credentials handled by backend
                        voice_id: voiceId,
                        text: text,
                        text_file_id: textFileId
                    })
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || '提交任务失败');
                if (data.base_resp && data.base_resp.status_code !== 0) throw new Error(data.base_resp.status_msg || '提交任务失败(API)');
                
                const taskId = data.task_id;
                statusText.innerHTML = `<span class="spinner-grow spinner-grow-sm me-2"></span>任务已提交 (ID: ${taskId})<br><small>等待处理... (每30秒查询一次)</small>`;
                
                // 3. Poll Status (Every 30 seconds)
                pollInterval = setInterval(() => pollStatus(taskId), 30000);
            }

        } catch (error) {
            handleError(error.message);
        } finally {
            if (mode === 'sync') btn.disabled = false;
        }
    }

    async function pollStatus(taskId) {
        const statusText = document.getElementById('status-text');
        const statusAlert = document.getElementById('status-alert');
        
        try {
            const response = await fetch(`/api/query?task_id=${taskId}`);
            const data = await response.json();

            if (!response.ok) throw new Error(data.error || '查询状态失败');
            
            const status = data.status; // Processing, Success, Failed, Expired
            
            if (status === 'Success') {
                clearInterval(pollInterval);
                statusAlert.className = 'alert alert-success status-alert text-center';
                statusText.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>生成成功！正在获取下载链接...';
                retrieveFile(data.file_id);
            } else if (status === 'Failed' || status === 'Expired') {
                clearInterval(pollInterval);
                handleError(`任务失败: ${status}`);
            } else {
                statusText.innerHTML = `<span class="spinner-grow spinner-grow-sm me-2"></span>处理中... (状态: ${status})<br><small>下次查询在 30 秒后</small>`;
            }
        } catch (error) {
            clearInterval(pollInterval);
            handleError(error.message);
        }
    }
    
    async function retrieveFile(fileId) {
        const statusText = document.getElementById('status-text');
        
        try {
            const response = await fetch(`/api/retrieve?file_id=${fileId}`);
            const data = await response.json();
            
            if (!response.ok) throw new Error(data.error || '获取文件失败');
            
            if (data.file && data.file.download_url) {
                statusText.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>准备就绪';
                createDownloadLink(data.file.download_url);
            } else {
                 throw new Error('未找到下载链接');
            }
        } catch (error) {
            handleError(error.message);
        } finally {
             document.getElementById('generate-btn').disabled = false;
        }
    }
    
    function createDownloadLink(url) {
        const resultContainer = document.getElementById('result-container');
        
        // Create Bootstrap styled download button
        const link = document.createElement('a');
        link.href = url;
        link.className = 'btn btn-success btn-lg shadow';
        link.download = `minimax_audio_${new Date().getTime()}.mp3`;
        link.target = '_blank';
        link.innerHTML = '<i class="bi bi-download me-2"></i>点击下载音频文件 (.mp3)';
        
        resultContainer.appendChild(link);
        document.getElementById('generate-btn').disabled = false;
    }

    function handleError(msg) {
        const statusAlert = document.getElementById('status-alert');
        const statusText = document.getElementById('status-text');
        const btn = document.getElementById('generate-btn');
        
        statusAlert.className = 'alert alert-danger status-alert text-center';
        statusText.innerHTML = `<i class="bi bi-x-circle-fill me-2"></i>错误: ${msg}`;
        btn.disabled = false;
    }
</script>

</body>
</html>
